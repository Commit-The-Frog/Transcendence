<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>PING PONG</title>
    <style>
            * {
        padding: 0;
        margin: 0;
      }
      body {
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      canvas {
        background: #eee;
        display: block;
        margin: 0 auto;
        border: 1px solid black;
      }
      h1, h2 {
        margin-bottom: 10px;
      }
      .input-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      label {
        margin-right: 10px;
      }
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-content {
        background: white;
        padding: 20px;
        border-radius: 5px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h2 id="msg">Please insert player nickname</h2>
    <button id="btn">start</button>

	<script src="./config/config.js"></script>
    <script>
		const body = document.body; // body 요소 선택
		const h2 = document.getElementById('msg');
		const button = document.getElementById('btn'); // 버튼 요소 선택
		const params = new URLSearchParams(window.location.search);
		const type = params.get('type');
		const mode = params.get('item_mode');
		const loc = params.get('location');
		const gameType = document.createElement('h1');
		let n, typeForBe;

		if (loc == 'local' && type == 1) {
			n = 2;
			gameType.textContent = '1 vs 1';
		}
		else if (loc == 'local' && type == 2) {
			n = 4;
			gameType.textContent = 'tournament';
		} else if (loc == 'remote' && type == 1) {
			n = 1;
			gameType.textContent = '1 vs 1';
		} else {
			n = 1;
			gameType.textContent = 'tournament';
		}

		if (type == 1)	typeForBe = '1vs1';
		else if (type == 2)	typeForBe = 'tournament';

		body.insertBefore(gameType, h2);
		for (let i = 1; i <= n; i++) {
			// 새 div 요소 생성
			const div = document.createElement('div');
			div.className = 'input-container';

			// label 요소 생성
			const label = document.createElement('label');
			label.setAttribute('for', `player${i}`);
			label.textContent = `Player ${i}:`;

			// input 요소 생성
			const input = document.createElement('input');
			input.id = `player${i}`;
			input.type = 'text';

			// div에 label과 input 추가
			div.appendChild(label);
			div.appendChild(input);

			// body에 div 추가 (버튼 앞에 추가)
			body.insertBefore(div, button);
		}
	  
		/*
			start 버튼 클릭시 매치메이킹 시작
		*/
		button.addEventListener('click', () => {
			let url = `${loc}.html?location=${loc}&type=${type}&item_mode=${mode}`;
			let nickname;

			for (let i = 1; i <= n; i++) {
				nickname = document.getElementById(`player${i}`).value;

				if (!nickname) {
					alert(`Player ${i} nickname is required!`);
					return ; // 하나라도 빈 값이 있으면 for 루프 중지
				}
				url += `&player${i}=${nickname}`;
			}
			if (loc == 'local')
				window.location.href = url;
			else if (loc == 'remote') {
				// 매치메이킹 모달 띄우기
				const modal = document.createElement('div');
				modal.className = 'modal';

				const modalContent = document.createElement('div');
				modalContent.className = 'modal-content';
				modalContent.textContent = '다른 플레이어를 기다리는 중....';

				modal.appendChild(modalContent);
				body.appendChild(modal);

				// 웹소켓 열고 매치메이킹 시작
				const wsUrl = `ws://${window.env.SERVER_IP}:${window.env.SERVER_PORT}/ws/game/lobby?type=${typeForBe}`;
				const ws = new WebSocket(wsUrl);

				ws.onopen = (event) => {
            		console.log("GameQueue WebSocket 오픈");
				}

				ws.onmessage = (event) => {
					const matchName = event.data;
					console.log(`서버로부터 매치 UUID 수신 : ${matchName}`);

					if (event.data) {
						modal.remove();
						window.location.href = `/game/${typeForBe}?match_name=${matchName}`;
					}
				}

				ws.onclose = (event) => {}
				ws.onerror = (error) => {
					alert("WebSocket error observed:", error);
					modal.remove();
				};
			}
		})
    </script>
  </body>
</html>
